<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å–®å­—äº’å‹•éŠæˆ²å¹³å° V7</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .btn-hover:active { transform: scale(0.95); }
    .ipa-font { font-family: 'Lucida Sans Unicode', 'Arial Unicode MS', sans-serif; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // *** è«‹å‹™å¿…å¡«å…¥æ‚¨çš„ Google Apps Script éƒ¨ç½²ç¶²å€ ***
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyn8trUyPRwevDv5vimovwkozRBLrqImcUXT8YqIp0LMoZj2tvQuGZ97srNI9Q9NPDI/exec"; 

    // ==========================================
    // UTILS
    // ==========================================
    const AudioEngine={ctx:null,muted:!1,init:function(){this.ctx||(this.ctx=new(window.AudioContext||window.webkitAudioContext))},setMuted:function(e){this.muted=e},playTone:function(e){if(!this.muted){this.init();"suspended"===this.ctx.state&&this.ctx.resume();var t=this.ctx.createOscillator(),n=this.ctx.createGain();t.connect(n),n.connect(this.ctx.destination),"correct"===e?(t.type="sine",t.frequency.setValueAtTime(523.25,this.ctx.currentTime),t.frequency.exponentialRampToValueAtTime(1046.5,this.ctx.currentTime+.1),n.gain.setValueAtTime(.3,this.ctx.currentTime),n.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.3)):(t.type="sawtooth",t.frequency.setValueAtTime(150,this.ctx.currentTime),t.frequency.linearRampToValueAtTime(100,this.ctx.currentTime+.2),n.gain.setValueAtTime(.3,this.ctx.currentTime),n.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.3)),t.start(),t.stop(this.ctx.currentTime+.3)}}};
    const TTS={speak:function(e,t){if(window.speechSynthesis){window.speechSynthesis.cancel();var n=new SpeechSynthesisUtterance(e);n.lang="en-US",n.rate=.85,n.onend=function(){t&&t()},window.speechSynthesis.speak(n)}}};
    function shuffle(e){let t=e.length,n;const i=[...e];for(;0!=t;)n=Math.floor(Math.random()*t),t--,[i[t],i[n]]=[i[n],i[t]];return i}
    function formatTime(e){const t=Math.floor(e/60),n=e%60;return`${t}m ${n<10?"0":""}${n}s`}

    const { useState, useEffect } = React;

    // ==========================================
    // MAIN APP
    // ==========================================
    function App() {
      const [view, setView] = useState('unit-select'); 
      const [units, setUnits] = useState([]);
      const [selectedUnit, setSelectedUnit] = useState('');
      const [db, setDb] = useState([]);
      const [user, setUser] = useState({ class: '', seat: '' });
      const [scores, setScores] = useState({});
      const [currentLevel, setCurrentLevel] = useState(null);
      const [exportStatus, setExportStatus] = useState(null);
      const [isMuted, setIsMuted] = useState(false);

      useEffect(() => {
        if (window.google && window.google.script) {
           window.google.script.run.withSuccessHandler((data) => setUnits(JSON.parse(data))).getUnits();
        } else {
           setUnits(['B2L1 (Local)']); 
        }
        window.addEventListener('beforeunload', (e) => { e.preventDefault(); e.returnValue=''; });
      }, []);

      const handleUnitSelect = (unit) => {
        setSelectedUnit(unit);
        setView('loading-data');
        if (window.google && window.google.script) {
          window.google.script.run.withSuccessHandler((data) => {
              setDb(JSON.parse(data));
              setView('login');
          }).getVocabData(unit);
        } else {
           setTimeout(() => { setDb([]); setView('login'); }, 500);
        }
      };

      const handleLogin = (c, s) => {
        setUser({ class: c, seat: s });
        setView('dashboard');
        AudioEngine.init();
      };

      // *** æ ¸å¿ƒä¿®å¾©ï¼šç¢ºä¿ä»»ä½•æ™‚å€™é€€å‡ºéƒ½èƒ½ä¿å­˜æˆç¸¾ ***
      const handleGameFinish = (levelId, score, time) => {
        setScores(prev => {
          const old = prev[levelId] || { score: 0, time: 0 };
          // é‚è¼¯ï¼šä¿ç•™æœ€é«˜åˆ†ã€‚è‹¥åˆ†æ•¸ç›¸åŒï¼Œä¿ç•™æ™‚é–“è¼ƒçŸ­è€…ã€‚
          if (score > old.score || (score === old.score && time < old.time && time > 0)) {
            return { ...prev, [levelId]: { score, time } };
          }
          // è‹¥ç‚ºç¬¬ä¸€æ¬¡éŠç© (èˆŠç´€éŒ„ç‚º0)ï¼Œç›´æ¥å¯«å…¥
          if (old.score === 0 && old.time === 0) {
            return { ...prev, [levelId]: { score, time } };
          }
          return prev;
        });
        setView('dashboard'); // è¿”å›ä¸»é¸å–®
      };

      const handleExport = () => {
        if(!GOOGLE_SCRIPT_URL.startsWith("http")) return alert("è«‹è¨­å®š Script URL");
        setExportStatus('sending');
        const totalScore = Object.values(scores).reduce((a, b) => a + b.score, 0);
        const totalTime = Object.values(scores).reduce((a, b) => a + b.time, 0);
        
        fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            className: user.class, seatNumber: user.seat,
            totalScore, totalTime, gameTitle: selectedUnit, levelDetails: scores
          })
        }).then(() => { setExportStatus('success'); alert('ä¸Šå‚³æˆåŠŸï¼'); setExportStatus('idle'); })
          .catch(() => { setExportStatus('error'); alert('ä¸Šå‚³å¤±æ•—'); });
      };

      const levels = [
        { id: 'L2-A', title: 'è½éŸ³é¸å­— (ç´”è½åŠ›)', cat: 'è¾¨è­˜', type: 'audio-only' },
        { id: 'L2-B', title: 'è½éŸ³é¸å­— (IPA)', cat: 'è¾¨è­˜', type: 'audio-word' },
        { id: 'L3', title: 'è½éŸ³é¸ç¾©', cat: 'è¾¨è­˜', type: 'audio-def' },
        { id: 'L4', title: 'è‹±ä¸­é…å°', cat: 'è¾¨è­˜', type: 'en-ch' },
        { id: 'L5', title: 'ä¸­è‹±é…å°', cat: 'è¾¨è­˜', type: 'ch-en' },
        { id: 'L10', title: 'éŸ³ç¯€èˆ‡é‡éŸ³', cat: 'æ‹¼å­—', type: 'syllable' },
        { id: 'L6', title: 'æ‹¼å­—é‡çµ„', cat: 'æ‹¼å­—', type: 'anagram' },
        { id: 'L1', title: 'è½éŸ³æ‹¼å­— (ç„¡æç¤º)', cat: 'æ‹¼å­—', type: 'spelling' },
        { id: 'L7', title: 'æ–‡æ„å­—å½™', cat: 'èªå¢ƒ', type: 'context' },
        { id: 'L8', title: 'ç¿»è­¯å¡«ç©º', cat: 'èªå¢ƒ', type: 'cloze' },
        { id: 'L9', title: 'å¥å­é‡çµ„', cat: 'èªå¢ƒ', type: 'sentence' },
      ];

      if (view === 'unit-select') return <UnitSelectionScreen units={units} onSelect={handleUnitSelect} />;
      if (view === 'loading-data') return <div className="h-screen flex items-center justify-center font-bold text-gray-500">è¼‰å…¥ {selectedUnit} è³‡æ–™ä¸­...</div>;

      return (
        <div className="min-h-screen bg-gray-50 text-gray-800 flex flex-col items-center">
          {view === 'login' && <LoginScreen gameTitle={selectedUnit} onLogin={handleLogin} />}
          {view === 'dashboard' && (
            <Dashboard 
              user={user} scores={scores} levels={levels} gameTitle={selectedUnit}
              onStart={(l)=>{setCurrentLevel(l); setView('game');}} 
              onExport={handleExport} exportStatus={exportStatus} 
              isMuted={isMuted} onToggleMute={()=>setIsMuted(!isMuted)}
              onBack={()=>setView('unit-select')}
            />
          )}
          {view === 'game' && (
            <GameEngine level={currentLevel} db={db} onFinish={handleGameFinish} isMuted={isMuted} />
          )}
        </div>
      );
    }

    // ==========================================
    // UI COMPONENTS
    // ==========================================
    
    function UnitSelectionScreen({ units, onSelect }) { 
      return (
        <div className="flex flex-col items-center justify-center min-h-screen px-4 fade-in">
          <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md border-t-4 border-indigo-500">
             <h1 className="text-2xl font-bold mb-2 text-center text-indigo-700">å–®å­—äº’å‹•å­¸ç¿’å¹³å°</h1>
             <p className="text-gray-500 text-center mb-6">è«‹é¸æ“‡è¦ç·´ç¿’çš„å–®å…ƒ</p>
             {units.length===0?<div className="text-center py-4 text-gray-400">è®€å–ä¸­...</div>:<div className="grid gap-3">{units.map(u=><button key={u} onClick={()=>onSelect(u)} className="w-full py-4 px-6 bg-gray-50 hover:bg-indigo-50 border-2 border-gray-200 hover:border-indigo-500 rounded-xl text-lg font-bold text-gray-700 hover:text-indigo-700 transition flex justify-between items-center group"><span>ğŸ“š {u}</span><span className="text-gray-300 group-hover:text-indigo-500">âœ</span></button>)}</div>}
          </div>
        </div>
      );
    }

    function LeaderboardWidget({ unit }) { 
       const [leaders, setLeaders] = useState([]);
       const [loading, setLoading] = useState(true);
       useEffect(() => {
         if (window.google && window.google.script) {
           window.google.script.run.withSuccessHandler((data) => { try { setLeaders(JSON.parse(data)); } catch(e) {} setLoading(false); }).getLeaderboard(unit);
         } else { setLoading(false); }
       }, [unit]);
       if (loading) return <div className="text-gray-400 text-xs text-center mt-4">è¼‰å…¥ {unit} æ¦®è­½æ¦œ...</div>;
       if (leaders.length === 0) return <div className="text-gray-400 text-sm text-center mt-6">ç›®å‰ {unit} å°šç„¡ç´€éŒ„ï¼Œæ¶é ­é¦™ï¼</div>;
       return (
         <div className="w-full max-w-sm mt-8 bg-white rounded-xl shadow-lg border border-yellow-100 overflow-hidden">
           <div className="bg-gradient-to-r from-yellow-400 to-orange-500 p-3 text-white font-bold text-center flex items-center justify-center gap-2"><span>ğŸ†</span> {unit} æ¦®è­½æ¦œ</div>
           <div className="divide-y divide-gray-100">{leaders.map((p, i) => (<div key={i} className={`flex justify-between items-center p-3 text-sm ${i===0?'bg-yellow-50':''}`}><div className="flex items-center gap-2"><span className="text-lg w-6 text-center">{i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':'ğŸ…'}</span><span className="font-bold text-gray-800">{p.cls}-{p.seat}</span></div><div className="text-right"><div className="font-bold text-indigo-600">{p.score}</div><div className="text-xs text-gray-400">{formatTime(p.time)}</div></div></div>))}</div>
         </div>
       );
    }

    function LoginScreen({ onLogin, gameTitle }) {
       const [cls, setCls] = useState('');
       const [seat, setSeat] = useState('');
       return (
         <div className="flex flex-col items-center justify-center min-h-screen w-full px-4 py-8">
           <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm fade-in border-t-4 border-indigo-500 z-10">
             <h1 className="text-2xl font-bold mb-2 text-center text-indigo-700">{gameTitle}</h1>
             <p className="text-center text-gray-400 text-sm mb-6">è¼¸å…¥ç­ç´šåº§è™Ÿé–‹å§‹æŒ‘æˆ°</p>
             <div className="space-y-4"><input required type="text" value={cls} onChange={e=>setCls(e.target.value)} className="block w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="ç­ç´š (å¦‚: 801)" /><input required type="number" value={seat} onChange={e=>setSeat(e.target.value)} className="block w-full border border-gray-300 p-3 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="åº§è™Ÿ (å¦‚: 05)" /></div>
             <button onClick={()=>cls&&seat&&onLogin(cls,seat)} className="w-full mt-6 bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition transform active:scale-95 shadow-md">Start</button>
           </div>
           <LeaderboardWidget unit={gameTitle} />
         </div>
       );
    }

    function Dashboard({ user, scores, levels, gameTitle, onStart, onExport, exportStatus, isMuted, onToggleMute, onBack }) {
      // ç¢ºä¿ç¸½åˆ†èˆ‡ç¸½æ™‚é–“æ˜¯å¾ scores ç‰©ä»¶å³æ™‚è¨ˆç®—çš„
      const totalScore = Object.values(scores).reduce((a,b)=>a+b.score, 0);
      const totalTime = Object.values(scores).reduce((a,b)=>a+b.time, 0);

      const Section = ({ title, color, catFilter }) => (
        <div className="mb-6">
          <h3 className={`text-lg font-bold mb-3 text-${color}-800 border-l-4 border-${color}-500 pl-2`}>{title}</h3>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            {levels.filter(l => l.cat === catFilter).map(l => (
              <button key={l.id} onClick={() => onStart(l)} className={`relative flex flex-col p-4 rounded-xl border-2 transition text-left btn-hover bg-${color}-50 hover:bg-${color}-100 border-${color}-200 shadow-sm`}>
                <span className="font-bold text-gray-800 text-lg mb-2">{l.title}</span>
                <div className="mt-auto text-sm text-gray-600 flex justify-between w-full border-t border-gray-200 pt-2">
                  <span className="font-semibold text-indigo-600">ğŸ† {scores[l.id]?.score||0}</span>
                  <span className="text-gray-500">â± {scores[l.id]?formatTime(scores[l.id].time):'--'}</span>
                </div>
              </button>
            ))}
          </div>
        </div>
      );
      return (
        <div className="w-full max-w-4xl p-4 fade-in">
          <header className="bg-white rounded-xl shadow-md p-5 mb-8 flex flex-col md:flex-row justify-between items-center border-b-4 border-indigo-100 sticky top-2 z-30">
            <div className="mb-4 md:mb-0">
              <div className="flex items-center gap-2"><button onClick={onBack} className="text-gray-400 hover:text-indigo-600 text-sm">â—€ æ›å–®å…ƒ</button><h2 className="text-2xl font-bold text-gray-800">{gameTitle}</h2></div>
              <div className="flex gap-4 mt-1 items-center">
                 <span className="bg-gray-100 px-2 py-1 rounded text-sm font-mono text-gray-600">{user.class}-{user.seat}</span>
                 <button onClick={onToggleMute} className={`px-2 py-1 rounded text-sm font-bold border ${isMuted?'bg-red-100 text-red-600 border-red-300':'bg-green-100 text-green-600 border-green-300'}`}>{isMuted?'ğŸ”‡':'ğŸ”ˆ'}</button>
              </div>
            </div>
            <div className="flex items-center gap-4 bg-gray-50 p-3 rounded-lg border border-gray-100">
              <div className="flex flex-col items-end pr-4 border-r-2 border-gray-200">
                <div className="text-xs text-gray-500 font-bold uppercase tracking-wider">Total Score</div>
                <div className="text-2xl font-black text-indigo-600">{totalScore}</div>
              </div>
              <div className="flex flex-col items-end pr-4 border-r-2 border-gray-200">
                <div className="text-xs text-gray-500 font-bold uppercase tracking-wider">Total Time</div>
                <div className="text-xl font-bold text-gray-700 font-mono">{formatTime(totalTime)}</div>
              </div>
              <button onClick={onExport} disabled={exportStatus==='sending'} className={`px-5 py-3 rounded-lg text-white font-bold shadow-md transition ${exportStatus==='sending'?'bg-gray-400':'bg-green-600 hover:bg-green-700'}`}>{exportStatus==='sending'?'...':'Save'}</button>
            </div>
          </header>
          <Section title="ä¸€ã€è¾¨è­˜èˆ‡é…å°" color="blue" catFilter="è¾¨è­˜" />
          <Section title="äºŒã€é€²éšæ‹¼å­—èˆ‡åˆ†æ" color="purple" catFilter="æ‹¼å­—" />
          <Section title="ä¸‰ã€èªå¢ƒæ‡‰ç”¨" color="pink" catFilter="èªå¢ƒ" />
        </div>
      );
    }

    // ==========================================
    // GAME ENGINE
    // ==========================================
    function GameEngine({ level, db, onFinish, isMuted }) {
      const [qList, setQList] = useState([]);
      const [idx, setIdx] = useState(0);
      const [score, setScore] = useState(0);
      const [startTime] = useState(Date.now());
      const [timer, setTimer] = useState(0); 
      const [input, setInput] = useState('');
      const [feedback, setFeedback] = useState(null); 
      const [isProcessing, setIsProcessing] = useState(false);
      const [currentOptions, setCurrentOptions] = useState([]); 
      const [sylCount, setSylCount] = useState(null);
      const [stressIdx, setStressIdx] = useState(null);
      const [scrambleChunks, setScrambleChunks] = useState([]);
      const [userChunks, setUserChunks] = useState([]);

      // 1. åˆå§‹åŒ–é¡Œç›®
      useEffect(() => {
        let qs = level.type === 'syllable' ? db.filter(w => w.type !== 'phr.') : [...db];
        qs = shuffle(qs); 
        setQList(qs);
        if (['audio-only', 'audio-word', 'audio-def'].includes(level.type) && qs.length > 0) setTimeout(() => TTS.speak(qs[0].word), 500);
        const interval = setInterval(() => { setTimer(Math.floor((Date.now() - startTime) / 1000)); }, 1000);
        return () => clearInterval(interval);
      }, [level]);

      // 2. é¡Œç›®åˆ‡æ›èˆ‡é¸é …å›ºå®š (Fix Options Jumping)
      useEffect(() => {
        setInput(''); setFeedback(null); setIsProcessing(false); setSylCount(null); setStressIdx(null); setUserChunks([]);
        const q = qList[idx]; 
        if (!q) return;

        // *** FIX: åªåœ¨é¡Œç›®è¼‰å…¥æ™‚ç”Ÿæˆä¸€æ¬¡é¸é …ï¼Œé¿å…é‡ç¹ªæ™‚è·³å‹• ***
        if (['audio-only', 'audio-word', 'audio-def', 'en-ch', 'ch-en', 'context'].includes(level.type)) {
           let others = db.filter(x => x.id !== q.id);
           if (level.type === 'context') others = others.filter(x => x.type === q.type); 
           if (others.length < 3) others = db.filter(x => x.id !== q.id);
           others = shuffle(others).slice(0, 3);
           const ops = shuffle([q, ...others]);
           setCurrentOptions(ops);
        }

        if (level.type === 'sentence' && q.chunks) setScrambleChunks(shuffle([...q.chunks]));
        if (['audio-only', 'audio-word', 'audio-def', 'syllable', 'spelling'].includes(level.type)) TTS.speak(q.word);
      }, [idx, qList, level]);

      // æ ¸å¿ƒï¼šæ‰‹å‹•é€€å‡ºæ™‚è§¸ç™¼å­˜æª”
      const handleManualExit = () => {
        const timeSpent = Math.floor((Date.now() - startTime) / 1000);
        // ç„¡è«–ç›®å‰å¹¾åˆ†ï¼Œéƒ½å›å‚³çµ¦ App é€²è¡Œæ¯”å°å­˜æª”
        onFinish(level.id, score, timeSpent); 
      };

      const handleNext = () => { if (idx < qList.length - 1) setIdx(prev => prev + 1); else onFinish(level.id, score, Math.floor((Date.now() - startTime) / 1000)); };
      
      const processResult = (isCorrect, currentQ) => {
        if (isProcessing) return; setIsProcessing(true);
        if (isCorrect) {
          setFeedback('correct'); setScore(prev => prev + 10); AudioEngine.playTone('correct');
          const textToRead = ['context', 'sentence', 'cloze'].includes(level.type) ? currentQ.sentence : currentQ.word;
          TTS.speak(textToRead, () => setTimeout(handleNext, 1000));
        } else {
          setFeedback(level.type === 'syllable' ? 'wrong-syllable' : 'wrong'); AudioEngine.playTone('wrong');
          if (['context', 'sentence', 'cloze', 'spelling', 'syllable', 'audio-only', 'audio-word'].includes(level.type)) {
             setFeedback('showAnswer'); TTS.speak(currentQ.sentence || currentQ.word, () => setTimeout(handleNext, 2500));
          } else { setTimeout(handleNext, 1000); }
        }
      };

      const checkAnswer = (val) => {
        const q = qList[idx]; let isCorrect = false;
        switch(level.type) {
          case 'spelling': case 'cloze': isCorrect = val.trim().toLowerCase() === q.word.toLowerCase(); break;
          case 'audio-only': case 'audio-word': case 'audio-def': case 'en-ch': case 'ch-en': case 'context': isCorrect = val === q.id; break;
          case 'anagram': isCorrect = val.toLowerCase() === q.word.toLowerCase(); break;
          case 'sentence': isCorrect = val.join('') === q.chunks.join(''); break;
          case 'syllable': isCorrect = (sylCount === q.syllables && stressIdx === q.stress); break;
        }
        processResult(isCorrect, q);
      };

      if (!qList[idx]) return <div className="p-8 text-center text-gray-500">è¼‰å…¥é¡Œç›®ä¸­...</div>;
      const q = qList[idx]; const progress = Math.round(((idx) / qList.length) * 100);

      const renderOptions = (renderContent) => (
         <div className="grid grid-cols-2 gap-4">
            {currentOptions.map(opt => (
               <button key={opt.id} onClick={() => checkAnswer(opt.id)} className="p-4 rounded-xl border-2 bg-white hover:border-indigo-500 hover:bg-indigo-50 text-lg font-bold text-gray-700 transition btn-hover shadow-sm min-h-[80px] flex items-center justify-center">
                  {renderContent(opt)}
               </button>
            ))}
         </div>
      );

      return (
        <div className="w-full max-w-2xl mx-auto h-screen md:h-auto md:min-h-[600px] flex flex-col bg-white md:my-8 md:rounded-2xl md:shadow-2xl overflow-hidden relative">
          <div className="bg-gray-100 p-4 flex justify-between items-center border-b">
            {/* é€€å‡ºæŒ‰éˆ•ç¾åœ¨æœƒè§¸ç™¼å­˜æª” */}
            <button onClick={handleManualExit} className="text-gray-500 font-bold hover:text-red-500 px-3">âœ• é€€å‡º</button>
            <div className="flex-1 mx-6"><div className="flex justify-between text-xs text-gray-400 mb-1"><span>Progress</span><span>{idx+1} / {qList.length}</span></div><div className="h-2 bg-gray-300 rounded-full overflow-hidden"><div className="h-full bg-indigo-500 transition-all duration-300" style={{width: `${progress}%`}}></div></div></div>
            <div className="flex gap-4 font-mono text-sm"><div className="text-gray-600">â± {formatTime(timer)}</div><div className="text-indigo-600 font-bold">{score} pts</div></div>
          </div>
          <div className="flex-1 p-6 flex flex-col justify-center items-center overflow-y-auto relative bg-slate-50">
            {feedback === 'correct' && <div className="absolute inset-0 bg-green-100/95 z-20 flex flex-col items-center justify-center fade-in"><div className="text-6xl mb-4 text-green-500">âœ…</div><div className="text-3xl font-bold text-green-800 ipa-font">{q.word}</div><div className="text-xl text-green-700 ipa-font my-2">{q.ipa}</div><div className="text-green-600 mt-2 px-4 text-center">{q.meaning}</div></div>}
            {feedback === 'showAnswer' && <div className="absolute inset-0 bg-red-50/95 z-20 flex flex-col items-center justify-center fade-in"><div className="text-6xl mb-4 text-red-400">ğŸ“–</div><div className="text-xl font-bold text-red-800 mb-1">Correct Answer:</div><div className="text-4xl text-red-900 font-bold mb-2 ipa-font">{q.word}</div><div className="text-red-700 ipa-font">{q.ipa}</div><div className="text-gray-600 mt-4 px-8 text-center">{q.sentence}</div></div>}
            
            <div className="w-full max-w-lg bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
              {level.type === 'audio-only' && <div className="text-center w-full"><div className="text-gray-500 mb-4 font-medium">è«‹ä»”ç´°è½ï¼Œé¸å‡ºæ­£ç¢ºçš„å–®å­— (ç´”è½åŠ›)</div><button onClick={() => TTS.speak(q.word)} className="mb-8 w-24 h-24 bg-gradient-to-br from-indigo-400 to-indigo-600 text-white rounded-full text-4xl hover:shadow-xl hover:scale-105 transition flex items-center justify-center mx-auto shadow-md">ğŸ”Š</button>
                  {renderOptions(opt => opt.word)}
              </div>}
              {level.type === 'syllable' && <div className="text-center"><div className="text-gray-600 mb-4 text-sm">è½ç™¼éŸ³ï¼Œåˆ¤æ–·éŸ³ç¯€èˆ‡é‡éŸ³</div><div className="text-3xl font-serif text-slate-700 mb-4 ipa-font tracking-wide">{q.ipa}</div><button onClick={() => TTS.speak(q.word)} className="mb-6 w-16 h-16 bg-teal-500 text-white rounded-full text-2xl hover:bg-teal-600 shadow-md flex items-center justify-center mx-auto transition">ğŸ”Š</button><div className="mb-6 bg-gray-50 p-4 rounded-lg"><p className="font-bold text-gray-700 mb-3 text-sm">1. é€™å€‹å–®å­—æœ‰å¹¾å€‹éŸ³ç¯€ï¼Ÿ</p><div className="flex justify-center gap-2">{[1,2,3,4,5,6].map(num => <button key={num} onClick={()=>setSylCount(num)} className={`w-10 h-10 rounded-lg border font-bold transition ${sylCount===num ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 hover:bg-gray-200'}`}>{num}</button>)}</div></div><div className="mb-8 bg-gray-50 p-4 rounded-lg"><p className="font-bold text-gray-700 mb-3 text-sm">2. é‡éŸ³åœ¨ç¬¬å¹¾å€‹éŸ³ç¯€ï¼Ÿ</p><div className="flex justify-center gap-2">{[1,2,3,4,5,6].map(num => <button key={num} onClick={()=>setStressIdx(num)} className={`w-10 h-10 rounded-lg border font-bold transition ${stressIdx===num ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 hover:bg-gray-200'}`}>{num}</button>)}</div></div><button onClick={()=>checkAnswer()} disabled={!sylCount || !stressIdx} className={`w-full py-3 rounded-lg font-bold text-white transition ${(!sylCount || !stressIdx) ? 'bg-gray-300' : 'bg-teal-600 hover:bg-teal-700 shadow-lg'}`}>ç¢ºèªç­”æ¡ˆ</button></div>}
              {level.type === 'audio-word' && <div className="text-center w-full"><div className="text-4xl font-serif text-slate-800 mb-6 ipa-font bg-yellow-50 inline-block px-4 py-2 rounded-lg border border-yellow-200">{q.ipa}</div><button onClick={() => TTS.speak(q.word)} className="w-16 h-16 bg-indigo-500 text-white rounded-full text-2xl hover:bg-indigo-600 shadow-lg flex items-center justify-center mx-auto mb-6">ğŸ”Š</button>
                  {renderOptions(opt => opt.word)}
              </div>}
              {level.type === 'spelling' && <div className="text-center"><button onClick={() => TTS.speak(q.word)} className="mb-8 w-20 h-20 bg-indigo-100 text-indigo-600 rounded-full text-4xl hover:bg-indigo-200 transition shadow flex items-center justify-center mx-auto">ğŸ”Š</button><input type="text" className="w-full text-center text-4xl border-b-4 border-indigo-300 outline-none focus:border-indigo-600 py-2 bg-transparent tracking-widest font-mono text-gray-700" value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && checkAnswer(input)} autoFocus autoComplete="off" /></div>}
              {level.type === 'audio-def' && <div className="w-full"><button onClick={() => TTS.speak(q.word)} className="mb-6 mx-auto w-16 h-16 bg-indigo-100 rounded-full text-3xl shadow-sm text-indigo-600 flex items-center justify-center">ğŸ”Š</button>
                 <div className="grid grid-cols-1 gap-3">{currentOptions.map(opt=><button key={opt.id} onClick={()=>checkAnswer(opt.id)} className="p-4 border-2 rounded-xl bg-white hover:bg-indigo-50 text-left text-gray-700 hover:border-indigo-300 transition font-medium min-h-[60px]">{opt.def}</button>)}</div>
              </div>}
              {(level.type === 'en-ch' || level.type === 'ch-en') && <div className="text-center"><div className="text-3xl font-bold mb-8 text-indigo-900 py-4 bg-indigo-50 rounded-lg">{level.type==='en-ch'?q.word:q.meaning}</div>
                 <div className="grid grid-cols-1 gap-3">{currentOptions.map(opt=><button key={opt.id} onClick={()=>checkAnswer(opt.id)} className="p-4 border-2 rounded-xl bg-white hover:bg-indigo-50 font-bold text-gray-700 hover:border-indigo-300 transition min-h-[60px]">{level.type==='en-ch'?opt.meaning:opt.word}</button>)}</div>
              </div>}
              {level.type === 'anagram' && <div className="text-center"><div className="text-gray-600 mb-4 text-lg font-medium">{q.meaning}</div><div className="flex flex-wrap gap-2 justify-center mb-6 min-h-[50px]">{input.split('').map((c,i)=><span key={i} onClick={()=>setInput(input.slice(0,i)+input.slice(i+1))} className="w-10 h-10 flex items-center justify-center bg-indigo-600 text-white rounded font-bold cursor-pointer shadow">{c}</span>)}</div><div className="flex flex-wrap gap-2 justify-center mb-8">{q.word.split('').sort().map((c,i)=><button key={i} onClick={()=>setInput(input+c)} className="w-10 h-10 bg-white border rounded font-bold hover:bg-gray-100">{c}</button>)}</div><button onClick={()=>checkAnswer(input)} className="bg-indigo-600 text-white px-8 py-2 rounded font-bold shadow hover:bg-indigo-700 transition">Check</button></div>}
              {level.type === 'context' && <div className="w-full"><div className="text-lg bg-gray-50 p-6 rounded-xl border-l-4 border-indigo-500 mb-6 leading-relaxed font-medium text-gray-700">{q.sentence.replace(new RegExp(q.word,'gi'),'_____')}</div>
                  {renderOptions(opt => opt.word)}
              </div>}
              {level.type === 'cloze' && <div className="text-center"><div className="mb-6 text-xl font-bold text-gray-700">{q.sentenceTrans}</div><div className="mb-8 text-lg leading-loose">{q.sentence.replace(q.word, '___').split('___').map((part,i,arr)=><span key={i}>{part}{i<arr.length-1 && <input type="text" autoFocus className="border-b-2 border-indigo-500 w-32 text-center outline-none bg-transparent font-bold text-indigo-700" value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&checkAnswer(input)} />}</span>)}</div><button onClick={()=>checkAnswer(input)} className="bg-indigo-600 text-white px-8 py-2 rounded font-bold shadow hover:bg-indigo-700 transition">Submit</button></div>}
              {level.type === 'sentence' && <div><div className="text-center mb-6 font-medium text-lg text-gray-700">{q.sentenceTrans}</div><div className="min-h-[60px] bg-indigo-50 p-4 mb-6 flex flex-wrap gap-2 rounded-xl border-2 border-dashed border-indigo-200 items-center justify-center">{userChunks.map((c,i)=><span key={i} onClick={()=>{setUserChunks(prev=>prev.filter((_,x)=>x!==i)); setScrambleChunks(prev=>[...prev,c]);}} className="bg-indigo-600 text-white px-3 py-1.5 rounded-lg cursor-pointer shadow font-medium">{c}</span>)}</div><div className="flex flex-wrap gap-2 justify-center mb-8">{scrambleChunks.map((c,i)=><button key={i} onClick={()=>{setScrambleChunks(prev=>prev.filter((_,x)=>x!==i)); setUserChunks(prev=>[...prev,c]);}} className="bg-white border px-3 py-1.5 rounded-lg hover:bg-gray-100 shadow-sm text-gray-700 font-medium">{c}</button>)}</div><button onClick={()=>checkAnswer(userChunks)} disabled={scrambleChunks.length>0} className={`w-full py-3 rounded-lg font-bold text-white transition shadow ${scrambleChunks.length>0?'bg-gray-300 cursor-not-allowed':'bg-green-600 hover:bg-green-700'}`}>Submit</button></div>}
            </div>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>